import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';

interface HelpSection {
  id: string;
  title: string;
  icon: string;
  expanded: boolean;
  items: HelpItem[];
}

interface HelpItem {
  question: string;
  answer: string;
}

@Component({
  selector: 'app-admin-help',
  standalone: true,
  imports: [CommonModule, FormsModule],
  templateUrl: './admin-help.component.html',
  styleUrl: './admin-help.component.scss'
})
export class AdminHelpComponent implements OnInit {
  searchTerm: string = '';
  filteredSections: HelpSection[] = [];

  helpSections: HelpSection[] = [
    {
      id: 'getting-started',
      title: 'Начало работы',
      icon: 'rocket',
      expanded: true,
      items: [
        {
          question: 'Как пользоваться административной панелью?',
          answer: 'Используйте боковое меню слева для перехода между модулями. Дашборд показывает сводную информацию и быстрый доступ к основным разделам. Каждый модуль имеет отдельную страницу для управления соответствующими сущностями.'
        },
        {
          question: 'Что такое Дашборд?',
          answer: 'Дашборд — это ваш центр управления, где отображается статистика в реальном времени, последние действия и быстрый доступ ко всем модулям. Здесь вы видите общее количество мероприятий, клубов, участников, регистраций и др.'
        },
        {
          question: 'Как создать новое мероприятие?',
          answer: 'Перейдите в Модули → Мероприятия, нажмите кнопку «Создать мероприятие», заполните все обязательные поля (название, описание, дата, площадка, клуб) и нажмите «Создать». Мероприятие появится в таблице сразу.'
        },
        {
          question: 'Можно ли редактировать существующие записи?',
          answer: 'Да! В большинстве модулей (Мероприятия, Клубы, Площадки и др.) рядом с каждой записью есть кнопка редактирования (значок карандаша). Нажмите её, измените нужные поля и сохраните изменения.'
        }
      ]
    },
    {
      id: 'managing-modules',
      title: 'Управление модулями',
      icon: 'grid',
      expanded: false,
      items: [
        {
          question: 'Какие существуют модули?',
          answer: 'Существует 15 модулей: Мероприятия, Клубы, Площадки, Судьи, Спонсоры, Волонтёры, Бюджеты, Отделы, Результаты, Участия, Регистрации, Отзывы, Пользователи, Администраторы и Комментарии. Каждый модуль управляет определённым типом сущности.'
        },
        {
          question: 'В каких модулях поддерживаются все операции CRUD?',
          answer: 'Полный набор операций CRUD (Создание, Чтение, Обновление, Удаление): Мероприятия, Клубы, Площадки, Судьи, Спонсоры, Волонтёры, Бюджеты, Отделы, Результаты и Администраторы. Только просмотр и удаление: Участия, Регистрации, Отзывы, Пользователи и Комментарии.'
        },
        {
          question: 'Как удалить запись?',
          answer: 'Нажмите на красный значок корзины рядом с любой записью. Появится модальное окно подтверждения. Подтвердите удаление, чтобы навсегда удалить запись. Примечание: Удаление определённых записей (например, Клубов) может привести к каскадному удалению связанных записей.'
        },
        {
          question: 'В чём разница между Пользователями и Администраторами?',
          answer: 'Пользователи — это студенты, регистрирующиеся на мероприятия. Администраторы — это администраторы платформы (вы!), управляющие всеми данными. Пароли пользователей всегда скрыты для обеспечения конфиденциальности. Пароли администраторов хранятся в виде хешей bcrypt для безопасности.'
        },
        {
          question: 'Могу ли я экспортировать данные?',
          answer: 'Да! В модуле Отзывы есть кнопка «Экспорт в Excel», которая загружает все данные отзывов в виде отформатированного файла .xlsx с правильной шириной столбцов.'
        }
      ]
    },
    {
      id: 'search-filter',
      title: 'Поиск и фильтрация',
      icon: 'search',
      expanded: false,
      items: [
        {
          question: 'Как искать записи?',
          answer: 'Каждый модуль имеет строку поиска вверху. Введите любое ключевое слово, чтобы отфильтровать записи в реальном времени. Поиск работает по нескольким полям (имя, email, описание и др.).'
        },
        {
          question: 'Как очистить поиск?',
          answer: 'Нажмите на кнопку "X", которая появляется в строке поиска, когда вы что-то ввели. Это сбросит вид и покажет все записи.'
        },
        {
          question: 'Работает ли поиск с частичными совпадениями?',
          answer: 'Да! Поиск не чувствителен к регистру и находит частичный текст. Например, поиск "tech" найдёт "TechFest", "technical" и "TechClub".'
        }
      ]
    },
    {
      id: 'activity-tracking',
      title: 'Отслеживание активности',
      icon: 'activity',
      expanded: false,
      items: [
        {
          question: 'Что такое страница Недавние?',
          answer: 'Страница Недавние показывает все действия администраторов в хронологическом порядке. Отображается, кто создал, обновил или удалил какую сущность и когда. Это помогает отслеживать изменения и контролировать действия администраторов.'
        },
        {
          question: 'Что отображается в разделе Недавняя активность на Дашборде?',
          answer: 'На Дашборде отображаются последние 5-10 недавних действий администраторов с описанием действия и временной меткой. Это даёт вам быстрый обзор недавних изменений без необходимости переходить на страницу Недавние.'
        },
        {
          question: 'Как долго хранится история активности?',
          answer: 'Все журналы активности хранятся в базе данных постоянно. Вы можете в любой момент просмотреть полную историю на странице Недавние.'
        }
      ]
    },
    {
      id: 'security',
      title: 'Безопасность и права доступа',
      icon: 'shield',
      expanded: false,
      items: [
        {
          question: 'Пароли безопасны?',
          answer: 'Абсолютно! Пароли пользователей и администраторов никогда не отображаются в интерфейсе. Пароли администраторов хешируются с использованием bcrypt (стандартное шифрование с однонаправленным ключом) перед хранением. Никто, включая администраторов, не может увидеть пароли в открытом виде.'
        },
        {
          question: 'Могу ли я удалить свою учётную запись администратора?',
          answer: 'Нет, система предотвращает самоуничтожение. Кнопка удаления отключена для вашей учётной записи, чтобы избежать случайных блокировок. Вы можете редактировать свою учётную запись, но не удалять её.'
        },
        {
          question: 'Кто может получить доступ к административной панели?',
          answer: 'Только пользователи с ролью администратора могут получить доступ к административной панели. Аутентификация администраторов отделена от аутентификации студентов. Администраторы должны входить в систему через страницу входа для администраторов.'
        },
        {
          question: 'Сохраняется ли моя сессия?',
          answer: 'Да! Когда вы входите в систему, ваша сессия сохраняется в localStorage. Если вы закроете браузер и вернётесь позже, вы будете автоматически перенаправлены на панель администратора без необходимости повторного входа.'
        }
      ]
    },
    {
      id: 'tips-tricks',
      title: 'Советы и рекомендации',
      icon: 'lightbulb',
      expanded: false,
      items: [
        {
          question: 'Как быстро обновить данные?',
          answer: 'Используйте кнопку "Синхронизировать" на Дашборде (значок вращающихся стрелок), чтобы обновить все статистические данные. Отдельные модули автоматически обновляют данные после операций Создания, Обновления или Удаления.'
        },
        {
          question: 'Что делать, если я случайно что-то удалил?',
          answer: 'Удаление является окончательным и не может быть отменено. Всегда дважды проверяйте перед подтверждением удаления. Модальное окно подтверждения показывает, что именно будет удалено, и предупреждает о каскадном удалении.'
        },
        {
          question: 'Как создать мероприятие со всеми связями?',
          answer: 'Перед созданием мероприятия убедитесь, что необходимые сущности существуют: Площадка, Клуб и Судья. Сначала создайте их в соответствующих модулях, затем они появятся в выпадающих списках формы создания мероприятия.'
        },
        {
          question: 'Могу ли я просматривать данные, отправленные пользователями?',
          answer: 'Да! Регистрации показывают, кто зарегистрировался на мероприятия, Участия показывают, кто принял участие, Отзывы показывают отзывы пользователей с оценками, а Комментарии показывают комментарии пользователей. Все эти данные доступны только для просмотра и удаления, чтобы сохранить целостность данных.'
        }
      ]
    },
    {
      id: 'troubleshooting',
      title: 'Устранение неполадок',
      icon: 'tool',
      expanded: false,
      items: [
        {
          question: 'Сообщение об успешном удалении не отображается',
          answer: 'Это было исправлено! Уведомления теперь используют паттерн YOKATTA (без *ngIf на элементах уведомлений, только привязка [class.show]). Если вы всё ещё не видите уведомлений, проверьте консоль браузера на наличие ошибок.'
        },
        {
          question: 'Списки выпадающих меню пустые в формах',
          answer: 'Пустые выпадающие списки означают, что связанные сущности ещё не созданы. Например, если выпадающий список площадок мероприятия пуст, перейдите в модуль Площадки и создайте площадки сначала.'
        },
        {
          question: 'Поиск не работает',
          answer: 'Убедитесь, что вы вводите текст в поле поиска и что записи существуют. Поиск фильтрует данные в реальном времени по мере ввода текста. Если совпадений нет, вы увидите сообщение "Нет результатов".'
        },
        {
          question: 'Как выйти из системы?',
          answer: 'Нажмите на своё имя/иконку внизу бокового меню. Это откроет параметры учётной записи, где вы сможете выйти из системы. Выход из системы очищает вашу сессию и перенаправляет на страницу входа.'
        }
      ]
    },
    {
      id: 'keyboard-shortcuts',
      title: 'Горячие клавиши',
      icon: 'keyboard',
      expanded: false,
      items: [
        {
          question: 'Существуют ли горячие клавиши?',
          answer: 'Хотя специальные горячие клавиши ещё не реализованы, вы можете использовать стандартные клавиши браузера: Ctrl+F для поиска по странице, Tab для навигации по полям формы, Enter для отправки форм и Esc для закрытия модальных окон.'
        },
        {
          question: 'Как быстро переключаться между модулями?',
          answer: 'Используйте боковое меню навигации. Нажмите на любое название модуля, чтобы мгновенно перейти к нему. Активный модуль выделен в боковом меню, так что вы всегда знаете, где находитесь.'
        }
      ]
    }
  ];

  ngOnInit() {
    this.filteredSections = [...this.helpSections];
  }

  toggleSection(sectionId: string) {
    const section = this.helpSections.find(s => s.id === sectionId);
    if (section) {
      section.expanded = !section.expanded;
    }
  }

  filterHelp() {
    const term = this.searchTerm.toLowerCase().trim();

    if (!term) {
      this.filteredSections = [...this.helpSections];
      // Reset all expanded states
      this.filteredSections.forEach(section => section.expanded = false);
      this.filteredSections[0].expanded = true; // Expand first section by default
      return;
    }

    // Filter sections and items based on search term
    this.filteredSections = this.helpSections
      .map(section => ({
        ...section,
        expanded: true, // Expand all matching sections
        items: section.items.filter(item =>
          item.question.toLowerCase().includes(term) ||
          item.answer.toLowerCase().includes(term)
        )
      }))
      .filter(section => section.items.length > 0);
  }

  clearSearch() {
    this.searchTerm = '';
    this.filterHelp();
  }

  get totalQuestions(): number {
    return this.helpSections.reduce((total, section) => total + section.items.length, 0);
  }

  get visibleQuestions(): number {
    return this.filteredSections.reduce((total, section) => total + section.items.length, 0);
  }
}
